#!/usr/bin/env bash
# nexus-deploy - Automated deployment from WSL2 to Raspberry Pi
# Usage: ./nexus-deploy [--host HOST] [--dry-run] [--restart] [--backup]

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Default values
PI_HOST="${NEXUS_PI_HOST:-100.122.207.23}"  # Tailscale IP or set via environment
PI_USER="${NEXUS_PI_USER:-didac}"
PI_PATH="/srv/projects/nexus"
LOCAL_PATH="$(pwd)"
DRY_RUN=false
RESTART_SERVICES=false
CREATE_BACKUP=false
DEPLOY_TYPE="incremental"  # incremental or full

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --host|-h)
            PI_HOST="$2"
            shift 2
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --restart|-r)
            RESTART_SERVICES=true
            shift
            ;;
        --backup|-b)
            CREATE_BACKUP=true
            shift
            ;;
        --full)
            DEPLOY_TYPE="full"
            shift
            ;;
        --help)
            echo "Usage: $0 [options]"
            echo ""
            echo "Options:"
            echo "  --host HOST, -h HOST    Raspberry Pi hostname or IP (default: $PI_HOST)"
            echo "  --dry-run               Show what would be deployed without deploying"
            echo "  --restart, -r           Restart n8n after deployment"
            echo "  --backup, -b            Create backup before deployment"
            echo "  --full                  Full sync (delete files not in source)"
            echo ""
            echo "Environment variables:"
            echo "  NEXUS_PI_HOST          Set default Pi host"
            echo "  NEXUS_PI_USER          Set default Pi user"
            echo ""
            echo "Examples:"
            echo "  $0 --dry-run"
            echo "  $0 --backup --restart"
            echo "  $0 --host 192.168.1.100"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

echo "╔═══════════════════════════════════════════════════════════╗"
echo "║            NEXUS DEPLOYMENT TO RASPBERRY PI              ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}DRY RUN MODE - No changes will be made${NC}"
    echo ""
fi

# Display deployment configuration
echo -e "${BLUE}━━━ DEPLOYMENT CONFIGURATION ━━━${NC}"
echo "Source: $LOCAL_PATH"
echo "Target: $PI_USER@$PI_HOST:$PI_PATH"
echo "Type: $DEPLOY_TYPE"
echo "Backup: $([ "$CREATE_BACKUP" = true ] && echo "Yes" || echo "No")"
echo "Restart services: $([ "$RESTART_SERVICES" = true ] && echo "Yes" || echo "No")"
echo ""

# Pre-deployment checks
echo -e "${BLUE}━━━ PRE-DEPLOYMENT CHECKS ━━━${NC}"
echo ""

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${YELLOW}⚠ Warning: Not in a git repository${NC}"
else
    # Check for uncommitted changes
    if [ -n "$(git status --porcelain)" ]; then
        echo -e "${YELLOW}⚠ Warning: You have uncommitted changes${NC}"
        git status --short | head -10
        echo ""
        echo -n "Continue deployment anyway? [y/N]: "
        read -r response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            echo "Deployment cancelled"
            exit 0
        fi
    else
        CURRENT_BRANCH=$(git branch --show-current)
        COMMIT_HASH=$(git rev-parse --short HEAD)
        echo -e "${GREEN}✓ Git status clean${NC}"
        echo "  Branch: $CURRENT_BRANCH"
        echo "  Commit: $COMMIT_HASH"
    fi
fi
echo ""

# Check SSH connectivity
echo "Testing SSH connection to $PI_HOST..."
if ssh -o ConnectTimeout=5 -o BatchMode=yes "$PI_USER@$PI_HOST" "echo 'Connected'" &>/dev/null; then
    echo -e "${GREEN}✓ SSH connection successful${NC}"
else
    echo -e "${RED}✗ Cannot connect to Pi${NC}"
    echo ""
    echo "Troubleshooting:"
    echo "  • Check Tailscale is running: tailscale status"
    echo "  • Verify Pi is online: ping $PI_HOST"
    echo "  • Test SSH manually: ssh $PI_USER@$PI_HOST"
    echo "  • Check SSH key: ssh-add -l"
    exit 1
fi
echo ""

# Check disk space on Pi
echo "Checking disk space on Pi..."
DISK_USAGE=$(ssh "$PI_USER@$PI_HOST" "df / | awk 'NR==2 {print \$5}' | sed 's/%//'")
if [ "$DISK_USAGE" -gt 85 ]; then
    echo -e "${RED}✗ Warning: Disk usage is ${DISK_USAGE}%${NC}"
    echo "  Consider running cleanup before deployment"
    echo -n "Continue anyway? [y/N]: "
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        exit 1
    fi
else
    echo -e "${GREEN}✓ Disk usage: ${DISK_USAGE}%${NC}"
fi
echo ""

# Create backup if requested
if [ "$CREATE_BACKUP" = true ]; then
    echo -e "${BLUE}━━━ CREATING BACKUP ━━━${NC}"
    echo ""

    BACKUP_NAME="pre-deploy-$(date +%Y%m%d-%H%M%S)"

    if [ "$DRY_RUN" = false ]; then
        echo "Creating backup on Pi: $BACKUP_NAME"
        ssh "$PI_USER@$PI_HOST" "cd $PI_PATH && tar -czf /tmp/nexus-backup-$BACKUP_NAME.tar.gz --exclude='*.pyc' --exclude='node_modules' --exclude='.git' ."

        if ssh "$PI_USER@$PI_HOST" "test -f /tmp/nexus-backup-$BACKUP_NAME.tar.gz"; then
            BACKUP_SIZE=$(ssh "$PI_USER@$PI_HOST" "du -h /tmp/nexus-backup-$BACKUP_NAME.tar.gz | cut -f1")
            echo -e "${GREEN}✓ Backup created: $BACKUP_SIZE${NC}"
            echo "  Location: /tmp/nexus-backup-$BACKUP_NAME.tar.gz"

            # Move to backup directory
            ssh "$PI_USER@$PI_HOST" "mkdir -p /mnt/backup/deploy-backups && mv /tmp/nexus-backup-$BACKUP_NAME.tar.gz /mnt/backup/deploy-backups/"
            echo "  Moved to: /mnt/backup/deploy-backups/"
        else
            echo -e "${RED}✗ Backup failed${NC}"
            exit 1
        fi
    else
        echo "Would create backup: $BACKUP_NAME"
    fi
    echo ""
fi

# Perform deployment
echo -e "${BLUE}━━━ DEPLOYING FILES ━━━${NC}"
echo ""

# Build rsync command
RSYNC_CMD="rsync -avz --progress"

# Exclude patterns
RSYNC_CMD="$RSYNC_CMD --exclude='.git'"
RSYNC_CMD="$RSYNC_CMD --exclude='node_modules'"
RSYNC_CMD="$RSYNC_CMD --exclude='__pycache__'"
RSYNC_CMD="$RSYNC_CMD --exclude='*.pyc'"
RSYNC_CMD="$RSYNC_CMD --exclude='.env'"
RSYNC_CMD="$RSYNC_CMD --exclude='.env.local'"
RSYNC_CMD="$RSYNC_CMD --exclude='venv'"
RSYNC_CMD="$RSYNC_CMD --exclude='.vscode'"
RSYNC_CMD="$RSYNC_CMD --exclude='.idea'"
RSYNC_CMD="$RSYNC_CMD --exclude='*.log'"

# Add delete flag for full sync
if [ "$DEPLOY_TYPE" = "full" ]; then
    RSYNC_CMD="$RSYNC_CMD --delete"
    echo -e "${YELLOW}Full sync mode: Will delete files not in source${NC}"
fi

# Add dry-run flag if requested
if [ "$DRY_RUN" = true ]; then
    RSYNC_CMD="$RSYNC_CMD --dry-run"
fi

# Add source and destination
RSYNC_CMD="$RSYNC_CMD $LOCAL_PATH/ $PI_USER@$PI_HOST:$PI_PATH/"

echo "Executing rsync..."
echo "Command: $RSYNC_CMD"
echo ""

if eval "$RSYNC_CMD"; then
    echo ""
    echo -e "${GREEN}✓ Files synced successfully${NC}"
else
    echo ""
    echo -e "${RED}✗ Deployment failed${NC}"
    exit 1
fi
echo ""

# Update permissions on deployed scripts
if [ "$DRY_RUN" = false ]; then
    echo "Setting script permissions..."
    ssh "$PI_USER@$PI_HOST" "find $PI_PATH/scripts -name '*.sh' -type f -exec chmod +x {} \;"
    echo -e "${GREEN}✓ Script permissions updated${NC}"
    echo ""
fi

# Install Python dependencies if requirements.txt changed
if [ "$DRY_RUN" = false ]; then
    echo -e "${BLUE}━━━ CHECKING DEPENDENCIES ━━━${NC}"
    echo ""

    # Check if requirements.txt exists and has changed
    if [ -f "$LOCAL_PATH/requirements.txt" ]; then
        echo "Checking Python dependencies..."

        # Get MD5 of local and remote requirements.txt
        LOCAL_MD5=$(md5sum "$LOCAL_PATH/requirements.txt" | cut -d' ' -f1)
        REMOTE_MD5=$(ssh "$PI_USER@$PI_HOST" "md5sum $PI_PATH/requirements.txt 2>/dev/null | cut -d' ' -f1" || echo "")

        if [ "$LOCAL_MD5" != "$REMOTE_MD5" ]; then
            echo -e "${YELLOW}requirements.txt changed, updating dependencies...${NC}"
            ssh "$PI_USER@$PI_HOST" "cd $PI_PATH && python3 -m pip install -r requirements.txt --user"
            echo -e "${GREEN}✓ Dependencies updated${NC}"
        else
            echo -e "${GREEN}✓ Dependencies up to date${NC}"
        fi
    fi
    echo ""
fi

# Restart services if requested
if [ "$RESTART_SERVICES" = true ] && [ "$DRY_RUN" = false ]; then
    echo -e "${BLUE}━━━ RESTARTING SERVICES ━━━${NC}"
    echo ""

    echo "Restarting n8n container..."
    if ssh "$PI_USER@$PI_HOST" "cd /srv/docker && docker compose restart n8n"; then
        echo -e "${GREEN}✓ n8n restarted${NC}"

        # Wait for health check
        echo "Waiting for n8n to be healthy..."
        sleep 5

        HEALTH_CHECK=0
        MAX_ATTEMPTS=30

        while [ $HEALTH_CHECK -lt $MAX_ATTEMPTS ]; do
            if ssh "$PI_USER@$PI_HOST" "docker inspect --format='{{.State.Health.Status}}' nexus-n8n 2>/dev/null | grep -q healthy"; then
                echo -e "${GREEN}✓ n8n is healthy${NC}"
                break
            fi

            echo -n "."
            sleep 1
            ((HEALTH_CHECK++))
        done

        if [ $HEALTH_CHECK -eq $MAX_ATTEMPTS ]; then
            echo -e "${RED}✗ n8n health check timeout${NC}"
            echo "Check logs: ssh $PI_USER@$PI_HOST 'docker logs nexus-n8n --tail 50'"
        fi
    else
        echo -e "${RED}✗ Failed to restart n8n${NC}"
    fi
    echo ""
fi

# Post-deployment verification
echo -e "${BLUE}━━━ POST-DEPLOYMENT VERIFICATION ━━━${NC}"
echo ""

if [ "$DRY_RUN" = false ]; then
    # Verify key files exist
    echo "Verifying deployment..."

    VERIFY_FILES=(
        "carousel.py"
        "requirements.txt"
        "docker-compose.yml"
        "scripts/README.md"
    )

    ALL_VERIFIED=true
    for file in "${VERIFY_FILES[@]}"; do
        if ssh "$PI_USER@$PI_HOST" "test -f $PI_PATH/$file"; then
            echo -e "  ${GREEN}✓${NC} $file"
        else
            echo -e "  ${RED}✗${NC} $file (missing)"
            ALL_VERIFIED=false
        fi
    done

    echo ""

    if [ "$ALL_VERIFIED" = true ]; then
        echo -e "${GREEN}✓ All key files verified${NC}"
    else
        echo -e "${YELLOW}⚠ Some files missing - review deployment${NC}"
    fi
else
    echo "Dry run completed. Review changes above."
fi
echo ""

# Deployment summary
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║                 DEPLOYMENT SUMMARY                       ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo ""

if [ "$DRY_RUN" = false ]; then
    echo -e "${GREEN}✓ Deployment completed successfully${NC}"
    echo ""
    echo "Deployed to: $PI_USER@$PI_HOST:$PI_PATH"

    if [ -n "${COMMIT_HASH:-}" ]; then
        echo "Git commit: $COMMIT_HASH"
    fi

    if [ "$CREATE_BACKUP" = true ]; then
        echo "Backup: /mnt/backup/deploy-backups/nexus-backup-$BACKUP_NAME.tar.gz"
    fi

    echo ""
    echo "Next steps:"
    echo "  • Test functionality: ssh $PI_USER@$PI_HOST"
    echo "  • Check logs: ssh $PI_USER@$PI_HOST '$PI_PATH/scripts/pi/nexus-logs.sh n8n'"
    echo "  • Monitor status: ssh $PI_USER@$PI_HOST '$PI_PATH/scripts/pi/nexus-health.sh'"

    if [ "$RESTART_SERVICES" = false ]; then
        echo "  • Restart services: ssh $PI_USER@$PI_HOST 'cd /srv/docker && docker compose restart n8n'"
    fi
else
    echo "Dry run completed successfully"
    echo ""
    echo "Re-run without --dry-run to perform actual deployment"
fi

echo ""
echo "Access n8n: http://$PI_HOST:5678"
echo ""
